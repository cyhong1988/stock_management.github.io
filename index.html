<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è‚¡ç¥¨æç›Šç®¡ç†ç³»çµ± v16</title>
    <style>
        :root { --up-color: #eb4d4b; --down-color: #6ab04c; --primary-bg: #f4f7f6; }
        body { font-family: "PingFang TC", "Microsoft JhengHei", sans-serif; background: var(--primary-bg); padding: 10px; color: #333; margin: 0; }
        .container { max-width: 700px; margin: auto; background: white; padding: 15px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        
        .summary-wrapper { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 15px; }
        .summary-card { flex: 1 1 120px; background: #2f3640; color: white; padding: 8px; border-radius: 6px; text-align: center; }
        .summary-card h4 { margin: 0; font-size: 0.7rem; opacity: 0.7; }
        .summary-card .amount { font-size: 1rem; font-weight: bold; margin-top: 2px; }

        .input-section { display: flex; flex-direction: column; gap: 10px; background: #fff; padding: 15px; border-radius: 8px; border: 1px solid #e2e8f0; margin-bottom: 15px; }
        .row { display: flex; gap: 10px; }
        .field { flex: 1; display: flex; flex-direction: column; }
        .field label { font-size: 0.8rem; font-weight: bold; margin-bottom: 5px; color: #4a5568; }
        .field-full { width: 100%; margin-bottom: 2px; }
        
        input, select { padding: 10px; border: 1px solid #cbd5e0; border-radius: 6px; font-size: 1rem; width: 100%; box-sizing: border-box; }
        input[readonly] { background: #edf2f7; font-weight: bold; border: 1px dashed #a0aec0; }
        
        .btn-add { background: #3182ce; color: white; font-weight: bold; height: 45px; border: none; border-radius: 6px; cursor: pointer; font-size: 1rem; margin-top: 5px; }
        .btn-add:disabled { background: #ccc; cursor: not-allowed; }

        #syncStatus { font-size: 0.75rem; text-align: center; margin-top: 5px; color: #718096; }

        .table-wrapper { width: 100%; border-top: 1px solid #edf2f7; }
        table { width: 100%; border-collapse: collapse; table-layout: fixed; }
        th, td { padding: 10px 2px; text-align: center; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; font-size: 0.82rem; }
        th { color: #718096; border-bottom: 2px solid #edf2f7; background: #fafafa; }
        td { border-bottom: 1px solid #f7fafc; }
        
        /* æ¬„ä½åˆ†é… */
        .w-date { width: 12%; }
        .w-name { width: 18%; }
        .w-qty { width: 12%; }
        .w-profit { width: 28%; }
        .w-pct { width: 12%; }
        .w-del { width: 6%; }

        .profit-up { color: var(--up-color); font-weight: bold; }
        .profit-down { color: var(--down-color); font-weight: bold; }
        .del-icon { color: #cbd5e0; cursor: pointer; border: none; background: none; font-size: 1rem; }
    </style>
</head>
<body>

<div class="container">
    <h3 style="text-align:center; margin: 0 0 15px 0;">ğŸ“ˆ è‚¡ç¥¨æç›Šç®¡ç†ç³»çµ±</h3>

    <div id="summarySection" class="summary-wrapper"></div>
    
    <div class="input-section">
        <div class="field field-full">
            <label>è²·é€²æ—¥æœŸ</label>
            <input type="date" id="buyDate" onblur="smartJump('sellDate')">
        </div>
        <div class="field field-full">
            <label>è³£å‡ºæ—¥æœŸ</label>
            <input type="date" id="sellDate">
        </div>

        <div class="row">
            <div class="field"><label>è‚¡ç¥¨åç¨±</label><input type="text" id="stockName"></div>
            <div class="field">
                <label>ç¨…ç‡</label>
                <select id="taxRate" onchange="calculate()">
                    <option value="0.003">3â€° (ä¸€èˆ¬è‚¡ç¥¨)</option>
                    <option value="0.001">1â€° (ç•¶æ²–/ETF)</option>
                </select>
            </div>
        </div>

        <div class="row">
            <div class="field"><label>è²·é€²å–®åƒ¹</label><input type="number" id="buyPrice" step="0.01" oninput="calculate()"></div>
            <div class="field"><label>è³£å‡ºå–®åƒ¹</label><input type="number" id="sellPrice" step="0.01" oninput="calculate()"></div>
        </div>

        <div class="field">
            <label>è‚¡æ•¸</label>
            <input type="number" id="quantity" value="1000" step="1" oninput="calculate()">
        </div>

        <div class="field">
            <label>é ä¼°ç¸½æ·¨æç›Š (æ‰£é™¤ç¨…è²»)</label>
            <input type="text" id="profitVal" readonly>
        </div>

        <button class="btn-add" id="submitBtn" onclick="addRow()">æ–°å¢ä¸¦æ›´æ–°</button>
        <div id="syncStatus"></div>
    </div>

    <div class="table-wrapper">
        <table>
            <thead>
                <tr>
                    <th class="w-date">è²·</th>
                    <th class="w-date">è³£</th>
                    <th class="w-name">è‚¡ç¥¨</th>
                    <th class="w-qty">è‚¡æ•¸</th>
                    <th class="w-profit">æ·¨æç›Š</th>
                    <th class="w-pct">å ±é…¬</th>
                    <th class="w-del"></th>
                </tr>
            </thead>
            <tbody id="stockTableBody"></tbody>
        </table>
    </div>
</div>

<script>
// è«‹åœ¨æ­¤è™•è²¼ä¸Šä½ çš„ Google Apps Script URL
const GAS_URL = "https://script.google.com/macros/s/AKfycbw5EnCPe3vXFgl4RKud7YwTRuyyKy4oSc4vWXLes-EmSA-LTo--gyaDf8OfCNkqZRitlA/exec";

let records = [];

// --- 1. è‡ªå‹•è¼‰å…¥é›²ç«¯ç´€éŒ„ ---
window.onload = async function() {
    if (GAS_URL.includes("YOUR_GAS_URL")) return;
    
    const status = document.getElementById('syncStatus');
    status.innerText = "æ­£åœ¨å¾é›²ç«¯åŒæ­¥æ­·å²ç´€éŒ„...";
    
    try {
        const response = await fetch(GAS_URL);
        const history = await response.json();
        
        if (history && history.length > 0) {
            // å°‡é›²ç«¯æŠ“å›ä¾†çš„é™£åˆ—è½‰æ›ç‚ºæœ¬åœ°é¡¯ç¤ºæ ¼å¼
            records = history.map(item => {
                const sDate = String(item.sellDate || "");
                return {
                    id: Date.now() + Math.random(),
                    bD: String(item.buyDate || "").substring(5, 10) || '--',
                    sD: sDate.substring(5, 10) || '--',
                    year: sDate.substring(0, 4) || 'æœªåˆ†é¡',
                    name: item.name,
                    qty: item.quantity || 1000,
                    net: parseFloat(item.net) || 0,
                    pct: item.pct || "0%"
                };
            }).reverse(); // è®“æœ€æ–°çš„åœ¨ä¸Šé¢
            
            updateUI();
            status.innerText = "âœ… åŒæ­¥å®Œæˆ";
        } else {
            status.innerText = "â˜ï¸ é›²ç«¯ç›®å‰ç„¡ç´€éŒ„";
        }
    } catch (e) {
        console.error("è¼‰å…¥å¤±æ•—:", e);
        status.innerText = "âš ï¸ ç„¡æ³•è®€å–é›²ç«¯è³‡æ–™ (è«‹ç¢ºèª GAS å·²ç™¼å¸ƒ)";
    }
};

// --- 2. åŸæœ‰çš„é‚è¼¯ä¿æŒä¸è®Š (smartJump, calculate, addRow, deleteRow, updateUI) ---

function smartJump(targetId) {
    const currentVal = document.getElementById('buyDate').value;
    const nextEl = document.getElementById(targetId);
    if (currentVal) {
        setTimeout(() => {
            nextEl.focus();
            if (nextEl.showPicker) nextEl.showPicker();
        }, 100);
    }
}

function calculate() {
    const bp = parseFloat(document.getElementById('buyPrice').value);
    const sp = parseFloat(document.getElementById('sellPrice').value);
    const tr = parseFloat(document.getElementById('taxRate').value);
    const qty = parseFloat(document.getElementById('quantity').value) || 0;

    if (bp && sp && qty > 0) {
        const feeR = 0.001425 * 0.25;
        const bFee = Math.max(20, Math.floor(bp * qty * feeR));
        const sFee = Math.max(20, Math.floor(sp * qty * feeR));
        const tax = Math.floor(sp * qty * tr);
        const net = (sp * qty) - (bp * qty) - bFee - sFee - tax;
        document.getElementById('profitVal').value = Math.round(net).toLocaleString();
    } else {
        document.getElementById('profitVal').value = "";
    }
}

async function addRow() {
    const name = document.getElementById('stockName').value;
    const bp = parseFloat(document.getElementById('buyPrice').value);
    const sp = parseFloat(document.getElementById('sellPrice').value);
    const qty = parseFloat(document.getElementById('quantity').value);
    const bD = document.getElementById('buyDate').value;
    const sD = document.getElementById('sellDate').value;

    if(!name || isNaN(bp) || isNaN(sp) || isNaN(qty)) return alert("è«‹å®Œæ•´å¡«å¯«è³‡è¨Š");

    const btn = document.getElementById('submitBtn');
    const status = document.getElementById('syncStatus');
    
    const tr = parseFloat(document.getElementById('taxRate').value);
    const feeR = 0.001425 * 0.25;
    const bFee = Math.max(20, Math.floor(bp * qty * feeR));
    const sFee = Math.max(20, Math.floor(sp * qty * feeR));
    const tax = Math.floor(sp * qty * tr);
    const net = (sp * qty) - (bp * qty) - bFee - sFee - tax;
    const pct = (net / (bp * qty + bFee) * 100).toFixed(1) + "%";

    const newRecord = {
        buyDate: bD,
        sellDate: sD,
        name: name,
        quantity: qty,
        net: Math.round(net),
        pct: pct
    };

    // å„²å­˜åˆ°é›²ç«¯
    btn.disabled = true;
    status.innerText = "æ­£åœ¨å„²å­˜åˆ°é›²ç«¯...";
    try {
        await fetch(GAS_URL, {
            method: "POST",
            mode: "no-cors",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(newRecord)
        });
        status.innerText = "âœ… å„²å­˜æˆåŠŸï¼";
    } catch (e) {
        status.innerText = "âŒ å„²å­˜å¤±æ•—ã€‚";
    }
    btn.disabled = false;

    // æœ¬åœ°å³æ™‚æ›´æ–°
    records.unshift({
        id: Date.now(),
        bD: bD.substring(5) || '--',
        sD: sD.substring(5) || '--',
        year: sD.split('-')[0] || 'æœªåˆ†é¡',
        name, qty, net, pct
    });

    updateUI();
    ['stockName','buyPrice','sellPrice','profitVal'].forEach(id => document.getElementById(id).value = "");
    document.getElementById('quantity').value = 1000;
}

function deleteRow(id) {
    if(confirm("ç¢ºå®šåˆªé™¤ï¼Ÿ(æ³¨æ„ï¼šé€™ä¸æœƒåˆªé™¤ Google Sheets ä¸Šçš„ç´€éŒ„)")) {
        records = records.filter(r => r.id !== id);
        updateUI();
    }
}

function updateUI() {
    const tbody = document.getElementById('stockTableBody');
    tbody.innerHTML = '';
    const stats = {};
    records.forEach(r => {
        const up = r.net >= 0;
        tbody.innerHTML += `
            <tr>
                <td>${r.bD}</td>
                <td>${r.sD}</td>
                <td><strong>${r.name}</strong></td>
                <td>${r.qty}</td>
                <td class="${up?'profit-up':'profit-down'}">${up?'+':''}${Math.round(r.net).toLocaleString()}</td>
                <td class="${up?'profit-up':'profit-down'}">${r.pct}</td>
                <td><button class="del-icon" onclick="deleteRow(${r.id})">âœ•</button></td>
            </tr>
        `;
        stats[r.year] = (stats[r.year] || 0) + r.net;
    });
    const sumSection = document.getElementById('summarySection');
    sumSection.innerHTML = '';
    Object.keys(stats).sort().reverse().forEach(y => {
        const val = stats[y];
        sumSection.innerHTML += `<div class="summary-card"><h4>${y} å¹´æç›Š</h4><div class="amount" style="color:${val>=0?'#ff7675':'#55efc4'}">${val>=0?'+':''}${Math.round(val).toLocaleString()}</div></div>`;
    });
}

</script>
</body>
</html>
