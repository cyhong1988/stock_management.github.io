<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ËÇ°Á•®ÊêçÁõäÁÆ°ÁêÜÁ≥ªÁµ± v17.3</title>
    <style>
        :root { --up-color: #eb4d4b; --down-color: #6ab04c; --primary-bg: #f4f7f6; }
        body { font-family: "PingFang TC", "Microsoft JhengHei", sans-serif; background: var(--primary-bg); padding: 10px; color: #333; margin: 0; }
        .container { max-width: 700px; margin: auto; background: white; padding: 15px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        
        .summary-wrapper { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 15px; }
        .summary-card { flex: 1 1 120px; background: #2f3640; color: white; padding: 8px; border-radius: 6px; text-align: center; }
        .summary-card h4 { margin: 0; font-size: 0.7rem; opacity: 0.7; }
        .summary-card .amount { font-size: 1rem; font-weight: bold; margin-top: 2px; }

        .input-section { display: flex; flex-direction: column; gap: 10px; background: #fff; padding: 15px; border-radius: 8px; border: 1px solid #e2e8f0; margin-bottom: 15px; }
        .row { display: flex; gap: 10px; }
        .field { flex: 1; display: flex; flex-direction: column; }
        .field label { font-size: 0.8rem; font-weight: bold; margin-bottom: 5px; color: #4a5568; }
        
        input, select { padding: 10px; border: 1px solid #cbd5e0; border-radius: 6px; font-size: 1rem; width: 100%; box-sizing: border-box; }
        input[readonly] { background: #edf2f7; font-weight: bold; border: 1px dashed #a0aec0; }
        
        .btn-add { background: #3182ce; color: white; font-weight: bold; height: 45px; border: none; border-radius: 6px; cursor: pointer; font-size: 1rem; margin-top: 5px; }
        
        #syncStatus { font-size: 0.75rem; text-align: center; margin-top: 5px; color: #718096; }

        /* Âπ¥‰ªΩÊ®ôÁ±§Ê®£Âºè */
        .year-filter-wrapper { display: flex; gap: 8px; margin: 15px 0 10px 0; overflow-x: auto; padding-bottom: 5px; }
        .year-tab { 
            padding: 6px 15px; background: #edf2f7; border-radius: 20px; font-size: 0.85rem; 
            cursor: pointer; white-space: nowrap; color: #4a5568; border: 1px solid transparent; transition: 0.2s;
        }
        .year-tab.active { background: #3182ce; color: white; font-weight: bold; }

        .table-wrapper { width: 100%; border-top: 1px solid #edf2f7; overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; table-layout: fixed; min-width: 340px; }
        th, td { padding: 10px 2px; text-align: center; font-size: 0.82rem; }
        th { color: #718096; border-bottom: 2px solid #edf2f7; background: #fafafa; }
        td { border-bottom: 1px solid #f7fafc; vertical-align: middle; }
        
        .w-date { width: 14%; }
        .w-info { width: 30%; } 
        .w-qty { width: 12%; }
        .w-profit { width: 22%; }
        .w-pct { width: 15%; }
        .w-del { width: 7%; }

        .day-trade-badge {
            background: #f1c40f; color: #000; font-size: 0.6rem; padding: 1px 4px;
            border-radius: 3px; font-weight: bold; margin-left: 3px; display: inline-block; vertical-align: middle;
        }

        .price-sub { font-size: 0.7rem; color: #a0aec0; display: block; margin-top: 2px; }
        .profit-up { color: var(--up-color); font-weight: bold; }
        .profit-down { color: var(--down-color); font-weight: bold; }
        .del-icon { color: #cbd5e0; cursor: pointer; border: none; background: none; font-size: 1rem; }
    </style>
</head>
<body>

<div class="container">
    <h3 style="text-align:center; margin: 0 0 15px 0;">üìà ËÇ°Á•®ÊêçÁõäÁÆ°ÁêÜÁ≥ªÁµ±</h3>

    <div id="summarySection" class="summary-wrapper"></div>
    
    <div class="input-section">
        <div class="row">
            <div class="field"><label>Ë≤∑ÈÄ≤Êó•Êúü</label><input type="date" id="buyDate" onblur="smartJump('sellDate')"></div>
            <div class="field"><label>Ë≥£Âá∫Êó•Êúü</label><input type="date" id="sellDate"></div>
        </div>

        <div class="row">
            <div class="field"><label>ËÇ°Á•®ÂêçÁ®±</label><input type="text" id="stockName"></div>
            <div class="field">
                <label>Á®ÖÁéá</label>
                <select id="taxRate" onchange="calculate()">
                    <option value="0.003">3‚Ä∞ (‰∏ÄËà¨ËÇ°Á•®)</option>
                    <option value="0.0015">1.5‚Ä∞ (Áï∂Ê≤ñ)</option>
                    <option value="0.001">1‚Ä∞ (ETF)</option>
                </select>
            </div>
        </div>

        <div class="row">
            <div class="field"><label>Ë≤∑ÈÄ≤ÂñÆÂÉπ</label><input type="number" id="buyPrice" step="0.01" oninput="calculate()"></div>
            <div class="field"><label>Ë≥£Âá∫ÂñÆÂÉπ</label><input type="number" id="sellPrice" step="0.01" oninput="calculate()"></div>
        </div>

        <div class="field">
            <label>ËÇ°Êï∏</label>
            <input type="number" id="quantity" value="1000" step="1" oninput="calculate()">
        </div>

        <div class="field">
            <label>È†ê‰º∞Á∏ΩÊ∑®ÊêçÁõä</label>
            <input type="text" id="profitVal" readonly>
        </div>

        <button class="btn-add" id="submitBtn" onclick="addRow()">Êñ∞Â¢û‰∏¶Êõ¥Êñ∞</button>
        <div id="syncStatus"></div>
    </div>

    <div id="yearTabs" class="year-filter-wrapper"></div>

    <div class="table-wrapper">
        <table>
            <thead>
                <tr>
                    <th class="w-date">Ë≤∑/Ë≥£</th>
                    <th class="w-info">ËÇ°Á•® (ÈÄ≤/Âá∫)</th>
                    <th class="w-qty">ËÇ°Êï∏</th>
                    <th class="w-profit">Ê∑®ÊêçÁõä</th>
                    <th class="w-pct">Â†±ÈÖ¨</th>
                    <th class="w-del"></th>
                </tr>
            </thead>
            <tbody id="stockTableBody"></tbody>
        </table>
    </div>
</div>

<script>
const GAS_URL = "https://script.google.com/macros/s/AKfycbw5EnCPe3vXFgl4RKud7YwTRuyyKy4oSc4vWXLes-EmSA-LTo--gyaDf8OfCNkqZRitlA/exec";
let records = [];
let currentFilterYear = 'ÂÖ®ÈÉ®';

window.onload = async function() {
    if (GAS_URL.includes("YOUR_GAS_URL")) return;
    const status = document.getElementById('syncStatus');
    status.innerText = "Ê≠£Âú®ÂæûÈõ≤Á´ØÂêåÊ≠•Ê≠∑Âè≤Á¥ÄÈåÑ...";
    try {
        const response = await fetch(GAS_URL);
        const history = await response.json();
        if (history && history.length > 0) {
            records = history.map(item => {
                const sDate = String(item.sellDate || "");
                let rawPct = item.pct ? String(item.pct) : "0";
                if (!rawPct.includes('%')) rawPct = (parseFloat(rawPct) * 100).toFixed(1) + "%";
                return {
                    id: Date.now() + Math.random(),
                    bD: String(item.buyDate || "").substring(5, 10) || '--',
                    sD: sDate.substring(5, 10) || '--',
                    year: sDate.substring(0, 4) || 'Êú™ÂàÜÈ°û',
                    name: item.name,
                    bp: item.buyPrice || 0,
                    sp: item.sellPrice || 0,
                    qty: item.quantity || 1000,
                    net: parseFloat(item.net) || 0,
                    pct: rawPct
                };
            }).reverse();
            updateUI();
            status.innerText = "‚úÖ ÂêåÊ≠•ÂÆåÊàê";
        }
    } catch (e) {
        status.innerText = "‚ö†Ô∏è ÁÑ°Ê≥ïËÆÄÂèñÈõ≤Á´ØË≥áÊñô";
    }
};

function smartJump(targetId) {
    const buyDateEl = document.getElementById('buyDate');
    const sellDateEl = document.getElementById('sellDate');
    if (buyDateEl.value) {
        if (!sellDateEl.value) sellDateEl.value = buyDateEl.value;
        const nextEl = document.getElementById(targetId);
        setTimeout(() => {
            nextEl.focus();
            if (nextEl.showPicker) nextEl.showPicker();
        }, 100);
    }
}

function calculate() {
    const bp = parseFloat(document.getElementById('buyPrice').value);
    const sp = parseFloat(document.getElementById('sellPrice').value);
    const tr = parseFloat(document.getElementById('taxRate').value);
    const qty = parseFloat(document.getElementById('quantity').value) || 0;
    if (bp && sp && qty > 0) {
        const feeR = 0.001425 * 0.25;
        const bFee = Math.max(20, Math.floor(bp * qty * feeR));
        const sFee = Math.max(20, Math.floor(sp * qty * feeR));
        const tax = Math.floor(sp * qty * tr);
        const net = (sp * qty) - (bp * qty) - bFee - sFee - tax;
        document.getElementById('profitVal').value = Math.round(net).toLocaleString();
    }
}

async function addRow() {
    const name = document.getElementById('stockName').value;
    const bp = parseFloat(document.getElementById('buyPrice').value);
    const sp = parseFloat(document.getElementById('sellPrice').value);
    const qty = parseFloat(document.getElementById('quantity').value);
    const bD = document.getElementById('buyDate').value;
    const sD = document.getElementById('sellDate').value;

    if(!name || isNaN(bp) || isNaN(sp)) return alert("Ë´ãÂ°´ÂØ´Ë≥áË®ä");

    const tr = parseFloat(document.getElementById('taxRate').value);
    const feeR = 0.001425 * 0.25;
    const bFee = Math.max(20, Math.floor(bp * qty * feeR));
    const sFee = Math.max(20, Math.floor(sp * qty * feeR));
    const tax = Math.floor(sp * qty * tr);
    const net = (sp * qty) - (bp * qty) - bFee - sFee - tax;
    const pct = (net / (bp * qty + bFee) * 100).toFixed(1) + "%";

    const newRecord = { 
        buyDate: bD, sellDate: sD, name: name, quantity: qty, 
        net: Math.round(net), pct: pct, buyPrice: bp, sellPrice: sp 
    };

    try {
        fetch(GAS_URL, { method: "POST", mode: "no-cors", body: JSON.stringify(newRecord) });
    } catch (e) {}

    records.unshift({
        id: Date.now(),
        bD: bD.substring(5), sD: sD.substring(5),
        year: sD.split('-')[0], name, bp, sp, qty, net, pct
    });
    updateUI();
    ['stockName','buyPrice','sellPrice','profitVal'].forEach(id => document.getElementById(id).value = "");
    document.getElementById('quantity').value = 1000;
}

async function deleteRow(id) {
    if(!confirm("Á¢∫ÂÆöË¶ÅÊ∞∏‰πÖÂà™Èô§Ê≠§Á≠ÜÈõ≤Á´ØÁ¥ÄÈåÑÂóéÔºü")) return;

    // 1. ÊâæÂà∞Êú¨Âú∞Ë≥áÊñô‰∏≠Â∞çÊáâÁöÑÈÇ£‰∏ÄÁ≠Ü
    const recordToDelete = records.find(r => String(r.id) === String(id));
    if (!recordToDelete) return;

    const status = document.getElementById('syncStatus');
    status.innerText = "‚è≥ Ê≠£Âú®ÂêåÊ≠•Âà™Èô§Ëá≥Èõ≤Á´Ø...";

    // 2. Ê∫ñÂÇôÂÇ≥ÈÄÅÁµ¶ GAS ÁöÑË≥áÊñô
    const deleteParams = {
        action: "delete",
        name: recordToDelete.name,
        net: Math.round(recordToDelete.net) // ÂÇ≥ÈÄÅÊï¥Êï∏ÊêçÁõä‰ª•‰æøÊØîÂ∞ç
    };

    try {
        // ‰ΩøÁî® POST ÁôºÈÄÅÂà™Èô§Ë´ãÊ±Ç
        await fetch(GAS_URL, {
            method: "POST",
            mode: "no-cors",
            body: JSON.stringify(deleteParams)
        });

        // 3. Èõ≤Á´ØÊåá‰ª§ÁôºÂá∫ÂæåÔºåÊõ¥Êñ∞Á∂≤È†Å UI
        records = records.filter(r => String(r.id) !== String(id));
        updateUI();
        
        status.innerText = "‚úÖ Èõ≤Á´ØË≥áÊñôÂ∑≤ÊàêÂäüÂà™Èô§";
        setTimeout(() => status.innerText = "", 3000);
    } catch (e) {
        status.innerText = "‚ùå Âà™Èô§Â§±ÊïóÔºåË´ãÊ™¢Êü•Á∂≤Ë∑Ø";
        console.error(e);
    }
}



function setYearFilter(year) {
    currentFilterYear = year;
    updateUI();
}

function updateUI() {
    const tbody = document.getElementById('stockTableBody');
    const tabContainer = document.getElementById('yearTabs');
    tbody.innerHTML = '';
    
    const stats = {};
    const yearsSet = new Set(['ÂÖ®ÈÉ®']);

    records.forEach(r => {
        stats[r.year] = (stats[r.year] || 0) + r.net;
        yearsSet.add(r.year);

        // ÈÅéÊøæÂπ¥‰ªΩ
        if (currentFilterYear !== 'ÂÖ®ÈÉ®' && r.year !== currentFilterYear) return;

        const up = r.net >= 0;
        const isDayTrade = r.bD === r.sD;
        
        tbody.innerHTML += `
            <tr>
                <td>${r.bD}<br>${r.sD}</td>
                <td>
                    <strong>${r.name}</strong>${isDayTrade ? '<span class="day-trade-badge">Áï∂Ê≤ñ</span>' : ''}
                    <span class="price-sub">${r.bp} ‚Üí ${r.sp}</span>
                </td>
                <td>${r.qty}</td>
                <td class="${up?'profit-up':'profit-down'}">${up?'+':''}${Math.round(r.net).toLocaleString()}</td>
                <td class="${up?'profit-up':'profit-down'}">${up && !r.pct.includes('+') ? '+' : ''}${r.pct}</td>
                <td><button class="del-icon" onclick="deleteRow(${r.id})">‚úï</button></td>
            </tr>
        `;
    });

    // Êõ¥Êñ∞‰∏äÊñπÂπ¥Â∫¶Áµ±Ë®àÂç°Áâá
    const sumSection = document.getElementById('summarySection');
    sumSection.innerHTML = '';
    Object.keys(stats).sort().reverse().forEach(y => {
        const val = stats[y];
        sumSection.innerHTML += `<div class="summary-card"><h4>${y} Âπ¥ÊêçÁõä</h4><div class="amount" style="color:${val>=0?'#ff7675':'#55efc4'}">${val>=0?'+':''}${Math.round(val).toLocaleString()}</div></div>`;
    });

    // Êõ¥Êñ∞Á¥ÄÈåÑÂçÄÂπ¥‰ªΩÊ®ôÁ±§
    tabContainer.innerHTML = '';
    Array.from(yearsSet).sort((a,b) => b.localeCompare(a)).forEach(y => {
        const isActive = y === currentFilterYear ? 'active' : '';
        tabContainer.innerHTML += `<div class="year-tab ${isActive}" onclick="setYearFilter('${y}')">${y}</div>`;
    });
}
</script>
</body>
</html>
